<!DOCTYPE html>
<html>

<head>
    <title>快速测试 - 聊天问题</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 200px;
        }
    </style>
</head>

<body>
    <h1>聊天问题快速诊断</h1>

    <div class="test-section">
        <h2>步骤 1: 检查 localStorage</h2>
        <button onclick="testLocalStorage()">运行测试</button>
        <div id="localStorage-result"></div>
    </div>

    <div class="test-section">
        <h2>步骤 2: 检查测试酱数据</h2>
        <button onclick="testTesterChat()">检查测试酱</button>
        <button onclick="fixTesterChat()">自动修复</button>
        <div id="tester-result"></div>
    </div>

    <div class="test-section">
        <h2>步骤 3: 对比林深和测试酱</h2>
        <button onclick="compareChats()">对比数据</button>
        <div id="compare-result"></div>
    </div>

    <script>
        function testLocalStorage() {
            const result = document.getElementById('localStorage-result');
            try {
                const data = localStorage.getItem('wechat_chats');
                if (!data) {
                    result.innerHTML = '<div class="error">❌ 未找到聊天数据</div>';
                    return;
                }

                const chats = JSON.parse(data);
                const chatCount = Object.keys(chats).length;
                result.innerHTML = `<div class="success">✓ 找到 ${chatCount} 个聊天</div>`;

                // 列出所有聊天
                let html = '<ul>';
                for (const [id, chat] of Object.entries(chats)) {
                    html += `<li>${chat.name} (ID: ${id})</li>`;
                }
                html += '</ul>';
                result.innerHTML += html;
            } catch (e) {
                result.innerHTML = `<div class="error">❌ 错误: ${e.message}</div>`;
            }
        }

        function testTesterChat() {
            const result = document.getElementById('tester-result');
            try {
                const data = localStorage.getItem('wechat_chats');
                if (!data) {
                    result.innerHTML = '<div class="error">❌ 未找到聊天数据</div>';
                    return;
                }

                const chats = JSON.parse(data);
                const tester = chats['char_tester'];

                if (!tester) {
                    result.innerHTML = '<div class="error">❌ 未找到测试酱 (char_tester)</div>';
                    return;
                }

                let issues = [];

                // 检查各项数据
                if (!tester.name) issues.push('缺少 name');
                if (!tester.avatar) issues.push('缺少 avatar');
                if (!tester.msgs) issues.push('缺少 msgs');
                if (tester.msgs && !Array.isArray(tester.msgs)) issues.push('msgs 不是数组');
                if (tester.msgs && tester.msgs.length > 0) {
                    tester.msgs.forEach((msg, i) => {
                        if (!msg.id) issues.push(`消息 ${i} 缺少 id`);
                        if (!msg.role) issues.push(`消息 ${i} 缺少 role`);
                        if (msg.content === undefined) issues.push(`消息 ${i} 缺少 content`);
                    });
                }

                if (issues.length === 0) {
                    result.innerHTML = '<div class="success">✓ 测试酱数据正常</div>';
                    result.innerHTML += `<pre>${JSON.stringify(tester, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<div class="error">❌ 发现 ${issues.length} 个问题:</div>`;
                    result.innerHTML += '<ul>' + issues.map(i => `<li>${i}</li>`).join('') + '</ul>';
                    result.innerHTML += `<pre>${JSON.stringify(tester, null, 2)}</pre>`;
                }
            } catch (e) {
                result.innerHTML = `<div class="error">❌ 错误: ${e.message}</div>`;
            }
        }

        function fixTesterChat() {
            const result = document.getElementById('tester-result');
            try {
                const data = localStorage.getItem('wechat_chats');
                if (!data) {
                    alert('未找到聊天数据');
                    return;
                }

                const chats = JSON.parse(data);
                const tester = chats['char_tester'];

                if (!tester) {
                    alert('未找到测试酱');
                    return;
                }

                // 修复数据
                if (!tester.msgs) tester.msgs = [];
                if (!Array.isArray(tester.msgs)) tester.msgs = [];

                // 修复每条消息
                tester.msgs = tester.msgs.map((msg, index) => {
                    return {
                        id: msg.id || (Date.now() + index),
                        role: msg.role || 'ai',
                        content: msg.content || '',
                        timestamp: msg.timestamp || Date.now(),
                        ...msg
                    };
                });

                // 确保基本字段存在
                if (!tester.name) tester.name = '测试酱';
                if (!tester.avatar) tester.avatar = '/avatars/小猫吃草莓.jpg';

                // 保存
                localStorage.setItem('wechat_chats', JSON.stringify(chats));
                result.innerHTML = '<div class="success">✓ 已修复!请刷新主页面</div>';
                testTesterChat();
            } catch (e) {
                result.innerHTML = `<div class="error">❌ 修复失败: ${e.message}</div>`;
            }
        }

        function compareChats() {
            const result = document.getElementById('compare-result');
            try {
                const data = localStorage.getItem('wechat_chats');
                if (!data) {
                    result.innerHTML = '<div class="error">❌ 未找到聊天数据</div>';
                    return;
                }

                const chats = JSON.parse(data);
                const linshen = chats['char_linshen'];
                const tester = chats['char_tester'];

                if (!linshen || !tester) {
                    result.innerHTML = '<div class="error">❌ 缺少对比数据</div>';
                    return;
                }

                let html = '<h3>林深 vs 测试酱</h3>';
                html += '<table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">';
                html += '<tr><th>字段</th><th>林深</th><th>测试酱</th></tr>';

                const fields = ['name', 'avatar', 'msgs', 'prompt', 'userName'];
                fields.forEach(field => {
                    const lValue = linshen[field];
                    const tValue = tester[field];
                    const lDisplay = Array.isArray(lValue) ? `数组(${lValue.length}项)` : JSON.stringify(lValue);
                    const tDisplay = Array.isArray(tValue) ? `数组(${tValue.length}项)` : JSON.stringify(tValue);
                    html += `<tr><td>${field}</td><td>${lDisplay}</td><td>${tDisplay}</td></tr>`;
                });

                html += '</table>';
                result.innerHTML = html;
            } catch (e) {
                result.innerHTML = `<div class="error">❌ 错误: ${e.message}</div>`;
            }
        }

        // 自动运行第一个测试
        window.onload = () => {
            testLocalStorage();
        };
    </script>
</body>

</html>